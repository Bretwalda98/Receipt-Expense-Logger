<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ingeniarch Labs · Receipt Logger</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            bg: { DEFAULT: '#0b1220', card: '#0f172a', line: '#20304b' },
            text: { DEFAULT: '#e6edf7', muted: '#a9b6cc' },
            acc: { DEFAULT: '#7dd3fc', fg: '#111827' },
            good: '#10b981', warn: '#eab308', bad: '#ef4444',
            brand: {
              50: '#eef9ff', 100: '#d7f1ff', 200: '#b3e3ff', 300: '#84d2ff',
              400: '#53bbff', 500: '#26a2ff', 600: '#1587db', 700: '#116cac',
              800: '#125887', 900: '#134a71', 950: '#0b2d47'
            }
          },
          boxShadow: {
            card: '0 10px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.03)'
          },
          borderRadius: { brand: '1.25rem' }
        }
      },
      darkMode: 'class'
    }
  </script>
  $1
  <!-- Excel export (with images) -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <style>
    html, body { height: 100%; }
    .glass { background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); backdrop-filter: blur(6px); }
    .grid-auto { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
  </style>
</head>
<body class="min-h-full bg-bg text-text">
  <div class="max-w-4xl mx-auto p-3 sm:p-6">
    <!-- Header -->
    <header class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-2xl bg-brand-600 flex items-center justify-center shadow-card">
          <!-- simple hex/logo mark -->
          <svg viewBox="0 0 24 24" class="w-6 h-6 text-white" fill="currentColor" aria-hidden="true">
            <path d="M12 2 3 7v10l9 5 9-5V7l-9-5Zm0 2.3 6.7 3.7v7.98L12 20.7 5.3 15.98V6L12 4.3Z"/>
            <path d="M7.5 8.5h9v2h-9zM7.5 13.5h5v2h-5z"/>
          </svg>
        </div>
        <div>
          <h1 class="text-lg font-semibold leading-tight">Ingeniarch Labs · Receipt Logger</h1>
          <p class="text-xs text-text-muted">Fast OCR, tidy records, one‑tap exports.</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="toggle-theme" class="text-xs px-3 py-2 rounded-xl bg-brand-700 hover:bg-brand-600 transition shadow-card">Theme</button>
      </div>
    </header><!-- Cloud auth -->
<section class="glass shadow-card rounded-brand p-3 sm:p-4 border border-bg-line mb-4">
  <div class="grid grid-auto gap-3">
    <div>
      <label class="text-xs block mb-1">Cloud</label>
      <select id="cloud-provider" class="w-full bg-bg-card border border-bg-line rounded-lg px-2 py-2 text-sm focus:outline-none">
        <option value="none">None</option>
        <option value="google">Google Drive</option>
        <option value="onedrive">OneDrive</option>
      </select>
    </div>
    <div>
      <label class="text-xs block mb-1">Status</label>
      <div id="auth-status" class="text-xs italic px-2 py-2 rounded-lg bg-bg-card border border-bg-line">Not signed in</div>
    </div>
    <div class="flex items-end">
      <button id="sign-in" class="w-full text-xs px-3 py-2 rounded-xl bg-brand-600 hover:bg-brand-500 transition shadow-card">Sign In</button>
    </div>
  </div>
</section>

<!-- Form + camera -->
<section class="glass shadow-card rounded-brand p-3 sm:p-4 border border-bg-line mb-4">
  <div class="grid grid-auto gap-3">
    <div>
      <label class="text-xs block mb-1">Date</label>
      <input id="date" type="date" class="w-full bg-bg-card border border-bg-line rounded-lg px-2 py-2 text-sm">
    </div>
    <div>
      <label class="text-xs block mb-1">Category</label>
      <select id="category" class="w-full bg-bg-card border border-bg-line rounded-lg px-2 py-2 text-sm">
        <option>Select</option>
        <option>Food</option>
        <option>Travel</option>
        <option>Supplies</option>
        <option>Other</option>
      </select>
    </div>
    <div>
      <label class="text-xs block mb-1">Amount (£)</label>
      <input id="amount" type="number" step="0.01" inputmode="decimal" placeholder="25.50" class="w-full bg-bg-card border border-bg-line rounded-lg px-2 py-2 text-sm">
    </div>
    <div class="sm:col-span-2">
      <label class="text-xs block mb-1">Description</label>
      <input id="desc" type="text" placeholder="Lunch" class="w-full bg-bg-card border border-bg-line rounded-lg px-2 py-2 text-sm">
    </div>
  </div>

  <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
    <div>
      <label class="text-xs block mb-1">Camera</label>
      <select id="camera-select" class="w-full bg-bg-card border border-bg-line rounded-lg px-2 py-2 text-sm"></select>
      <video id="video" autoplay playsinline class="mt-2 w-full aspect-[4/3] rounded-lg border border-bg-line"></video>
      <img id="preview-img" alt="Preview" class="mt-2 w-full rounded-lg border border-bg-line hidden" />
      <canvas id="canvas" class="hidden"></canvas>
      <div class="flex gap-2 mt-2">
        <button id="capture" class="flex-1 text-xs px-3 py-2 rounded-xl bg-brand-600 hover:bg-brand-500 transition shadow-card">Capture & Scan</button>
        <button id="native-capture" class="text-xs px-3 py-2 rounded-xl bg-bg-card border border-bg-line">Use Native</button>
        <input type="file" id="file-input" accept="image/*" capture="environment" class="hidden">
      </div>
      <p id="ocr-status" class="text-xs text-text-muted mt-1"></p>
    </div>
    <div>
      $1<div class="grid grid-cols-2 gap-2">
        <button id="log-btn" class="text-xs px-3 py-2 rounded-xl bg-good/90 hover:bg-good transition shadow-card hidden">Log<\/button>
        <button id="view-logs" class="text-xs px-3 py-2 rounded-xl bg-bg-card border border-bg-line">View Logs<\/button>
        <button id="export-csv" class="text-xs px-3 py-2 rounded-xl bg-bg-card border border-bg-line">Export CSV<\/button>
        <button id="export-xlsx" class="text-xs px-3 py-2 rounded-xl bg-bg-card border border-bg-line">Export Excel (.xlsx)<\/button>
        <button id="import-json" class="text-xs px-3 py-2 rounded-xl bg-bg-card border border-bg-line">Import JSON<\/button>
        <input id="import-file" type="file" accept="application/json" class="hidden" />
      <\/div>
      <div id="toast" class="mt-3 text-xs hidden"></div>
    </div>
  </div>
</section>

<!-- Logs -->
<section id="logs" class="glass shadow-card rounded-brand p-3 sm:p-4 border border-bg-line hidden">
  <div class="flex items-center justify-between mb-2">
    <h2 class="text-sm font-semibold">Saved Logs</h2>
    <div class="flex gap-2">
      <select id="month-filter" class="text-xs bg-bg-card border border-bg-line rounded-lg px-2 py-1">
        <option value="all">All months</option>
      </select>
      <button id="clear-logs" class="text-xs px-3 py-1.5 rounded-xl bg-bad/80 hover:bg-bad">Clear All</button>
    </div>
  </div>
  <div class="overflow-x-auto">
    <table class="w-full text-sm">
      <thead class="text-left text-xs text-text-muted border-b border-bg-line">
        <tr>
          <th class="py-2 pr-2">Date</th>
          <th class="py-2 pr-2">Cat</th>
          <th class="py-2 pr-2">Amt (£)</th>
          <th class="py-2 pr-2">Desc</th>
          <th class="py-2 pr-2">Photo</th>
          <th class="py-2 pr-2">Cloud</th>
          <th class="py-2 pr-2">Del</th>
        </tr>
      </thead>
      <tbody id="log-tbody"></tbody>
    </table>
  </div>
  <div class="mt-3 flex items-center justify-between">
    <p id="total-amount" class="text-sm"></p>
    <p id="count-info" class="text-xs text-text-muted"></p>
  </div>
</section>

  </div>  <!-- Image popup -->  <div id="popup" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50">
    <div class="bg-bg-card rounded-2xl p-3 sm:p-4 max-w-[95vw] max-h-[90vh] shadow-card border border-bg-line">
      <img id="popup-img" class="max-w-full max-h-[70vh] rounded-lg border border-bg-line" alt="Receipt" />
      <button id="close-popup" class="mt-3 w-full text-xs px-3 py-2 rounded-xl bg-brand-600 hover:bg-brand-500 transition">Close</button>
    </div>
  </div>  <script>
    // ===== Brand Defaults =====
    const BRAND = {
      name: 'Ingeniarch Labs',
      storageKey: 'expenses_logs',
      themeKey: 'il_theme',
    };

    // ===== Google API Setup =====
    const GOOGLE_CLIENT_ID = 'YOUR_GOOGLE_CLIENT_ID';
    const GOOGLE_API_KEY = 'YOUR_GOOGLE_API_KEY';
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
    const GOOGLE_SCOPES = 'https://www.googleapis.com/auth/drive.file';

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    let googleAccessToken = null;

    function gapiLoaded() { if (window.gapi) gapi.load('client', initializeGapiClient); }
    async function initializeGapiClient() {
      try {
        await gapi.client.init({ apiKey: GOOGLE_API_KEY, discoveryDocs: [DISCOVERY_DOC] });
        gapiInited = true; updateAuthStatus();
      } catch (err) { notify('Google API init failed – check keys & origin.', 'warn'); console.error(err); }
    }
    function gisLoaded() {
      try {
        tokenClient = google.accounts.oauth2.initTokenClient({ client_id: GOOGLE_CLIENT_ID, scope: GOOGLE_SCOPES, callback: '' });
        gisInited = true; updateAuthStatus();
      } catch (err) { notify('Google Identity init failed – check client id.', 'warn'); console.error(err); }
    }
    function handleGoogleAuth() {
      if (!gisInited || !gapiInited || !tokenClient) { notify('Google APIs not loaded.', 'warn'); return; }
      tokenClient.callback = (resp) => {
        if (resp.error) { console.error('Google auth error:', resp); notify('Google auth error.', 'bad'); return; }
        googleAccessToken = resp.access_token; gapi.client.setToken({ access_token: googleAccessToken }); updateAuthStatus();
      };
      if (!gapi.client.getToken()) tokenClient.requestAccessToken({ prompt: 'consent' }); else tokenClient.requestAccessToken({ prompt: '' });
    }
    async function uploadToGoogle(blob, filename) {
      const metadata = { name: filename, mimeType: 'image/jpeg' };
      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
      form.append('file', blob);
      const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
        method: 'POST', headers: new Headers({ Authorization: 'Bearer ' + googleAccessToken }), body: form,
      });
      const val = await res.json(); if (val.error) throw new Error(val.error.message);
      // Build a view URL hint for convenience (may require user perms)
      return { id: val.id, url: `https://drive.google.com/file/d/${val.id}/view` };
    }

    // ===== OneDrive (MSAL) =====
    const MSAL_CLIENT_ID = 'YOUR_MSAL_CLIENT_ID';
    const MSAL_AUTHORITY = 'https://login.microsoftonline.com/common';
    const MSAL_REDIRECT_URI = window.location.origin;
    const MSAL_SCOPES = ['Files.ReadWrite'];

    const msalInstance = new msal.PublicClientApplication({ auth: { clientId: MSAL_CLIENT_ID, authority: MSAL_AUTHORITY, redirectUri: MSAL_REDIRECT_URI } });
    let microsoftAccount = null; let microsoftAccessToken = null;

    async function handleMicrosoftAuth() {
      try {
        const response = await msalInstance.loginPopup({ scopes: MSAL_SCOPES });
        microsoftAccount = response.account; microsoftAccessToken = response.accessToken; updateAuthStatus();
      } catch (err) { console.error('MSAL error:', err); notify('Microsoft auth error.', 'bad'); }
    }
    async function getMicrosoftToken() {
      if (!microsoftAccount) throw new Error('No Microsoft account');
      try {
        const response = await msalInstance.acquireTokenSilent({ scopes: MSAL_SCOPES, account: microsoftAccount });
        microsoftAccessToken = response.accessToken;
      } catch (err) {
        const response = await msalInstance.acquireTokenPopup({ scopes: MSAL_SCOPES });
        microsoftAccessToken = response.accessToken;
      }
    }
    async function uploadToOneDrive(blob, filename) {
      await getMicrosoftToken();
      const url = `https://graph.microsoft.com/v1.0/me/drive/root:/${encodeURIComponent(filename)}:/content`;
      const res = await fetch(url, { method: 'PUT', headers: { Authorization: 'Bearer ' + microsoftAccessToken, 'Content-Type': 'image/jpeg' }, body: blob });
      const val = await res.json(); if (val.error) throw new Error(val.error.message);
      return { id: val.id, url: val.webUrl || null };
    }

    // ===== App State =====
    const $ = (id) => document.getElementById(id);
    const video = $('video'); const canvas = $('canvas'); const previewImg = $('preview-img');
    const dateInput = $('date'); const categorySelect = $('category');
    const amountInput = $('amount'); const descInput = $('desc');
    const captureBtn = $('capture'); const logBtn = $('log-btn');
    const viewLogsBtn = $('view-logs'); const logsSection = $('logs');
    const logTbody = $('log-tbody'); const totalAmountP = $('total-amount');
    const countInfo = $('count-info'); const toggleThemeBtn = $('toggle-theme');
    const cloudSelect = $('cloud-provider'); const signInBtn = $('sign-in');
    const authStatus = $('auth-status'); const popup = $('popup'); const popupImg = $('popup-img');
    const closePopup = $('close-popup'); const clearLogsBtn = $('clear-logs'); const cameraSelect = $('camera-select');
    const nativeCaptureBtn = $('native-capture'); const fileInput = $('file-input');
    const toast = $('toast'); const ocrStatus = $('ocr-status'); const exportCsv = $('export-csv');
    const importJsonBtn = $('import-json'); const importFile = $('import-file'); $1 const exportXlsxBtn = $('export-xlsx');

    let stream; let capturedBlob = null; let cameras = [];
    let logs = readLogs();

    function readLogs() {
      // Migrate any legacy storage key silently
      const raw = localStorage.getItem(BRAND.storageKey);
      try { return raw ? JSON.parse(raw) : []; } catch { return []; }
    }
    function saveLogs() { localStorage.setItem(BRAND.storageKey, JSON.stringify(logs)); }

    // ===== Utilities =====
    function notify(msg, level = 'info') {
      toast.classList.remove('hidden');
      toast.textContent = msg;
      const base = 'px-3 py-2 rounded-xl border text-xs';
      const map = { info: 'bg-brand-700 border-brand-600', warn: 'bg-warn/20 border-warn/40', bad: 'bg-bad/20 border-bad/40', good: 'bg-good/20 border-good/40' };
      toast.className = base + ' ' + (map[level] || map.info) + ' mt-3';
      setTimeout(() => { toast.classList.add('hidden'); }, 3200);
    }
    function fmtGBP(n) { if (isNaN(n)) return ''; return Number(n).toFixed(2); }
    function todayISO() { return new Date().toISOString().split('T')[0]; }

    // Month filter setup from logs
    function refreshMonthFilter() {
      const months = new Set(logs.map(l => (l.date || '').slice(0,7)).filter(Boolean));
      const existing = new Set(Array.from(monthFilter.options).map(o => o.value));
      months.forEach(m => { if (!existing.has(m)) { const opt = document.createElement('option'); opt.value = m; opt.textContent = m; monthFilter.appendChild(opt); } });
    }

    // ===== Theme =====
    function applyTheme() {
      const mode = localStorage.getItem(BRAND.themeKey) || 'dark';
      document.documentElement.classList.toggle('dark', mode === 'dark');
      document.body.classList.toggle('bg-white', mode !== 'dark');
    }
    toggleThemeBtn.addEventListener('click', () => {
      const curr = localStorage.getItem(BRAND.themeKey) || 'dark';
      localStorage.setItem(BRAND.themeKey, curr === 'dark' ? 'light' : 'dark');
      applyTheme();
    });

    // ===== Camera =====
    async function loadCameras() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        cameras = devices.filter(d => d.kind === 'videoinput');
        cameraSelect.innerHTML = cameras.map((d, i) => `<option value="${d.deviceId}">${d.label || 'Camera ' + (i + 1)}</option>`).join('');
        if (cameras.length) startCamera(cameras[0].deviceId); else notify('No camera found', 'warn');
      } catch (err) { console.error(err); notify('Unable to list cameras', 'bad'); }
    }
    async function startCamera(deviceId) {
      stopCamera();
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: deviceId ? { deviceId: { exact: deviceId } } : { facingMode: 'environment' }, audio: false });
        video.srcObject = stream; video.classList.remove('hidden'); previewImg.classList.add('hidden');
      } catch (err) { console.error('Camera error', err); notify('Camera error: ' + err.message, 'bad'); }
    }
    function stopCamera() { if (stream) { stream.getTracks().forEach(t => t.stop()); video.srcObject = null; } }
    cameraSelect.addEventListener('change', (e) => startCamera(e.target.value));
    nativeCaptureBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => { if (e.target.files[0]) handleBlob(e.target.files[0]); });

    // ===== OCR =====
    async function processOCR(blob) {
      ocrStatus.textContent = 'Scanning…';
      try {
        const worker = await Tesseract.createWorker('eng');
        const { data: { text } } = await worker.recognize(blob);
        await worker.terminate();
        ocrStatus.textContent = '';
        parseReceiptText(text);
        notify('Scan complete – check fields.', 'good');
      } catch (err) { ocrStatus.textContent = ''; notify('OCR error: ' + err.message, 'bad'); }
    }

    function parseReceiptText(text) {
      // Amount: choose the MAX currency-like number or the one near TOTAL
      const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      const totalLine = lines.find(l => /total|amount due|grand total/i.test(l)) || '';
      const moneyRegex = /(?:(?:£|GBP)\s*)?(\d{1,4}(?:[.,]\d{3})*(?:[.,]\d{2}))/g;
      const candidates = [];
      lines.forEach((l, idx) => {
        let m; while ((m = moneyRegex.exec(l)) !== null) {
          const v = parseFloat(m[1].replace(/,/g, '.'));
          candidates.push({ v, idx, line: l });
        }
      });
      let pick = null;
      if (totalLine) {
        const i = lines.indexOf(totalLine);
        pick = candidates.filter(c => Math.abs(c.idx - i) <= 2).sort((a,b)=>b.v-a.v)[0] || null;
      }
      if (!pick && candidates.length) pick = candidates.sort((a,b)=>b.v-a.v)[0];
      if (pick) amountInput.value = fmtGBP(pick.v);

      // Date: prefer UK dd/mm/yyyy or dd-mm-yyyy; fallback mm/dd/yyyy
      const dateUK = text.match(/\b(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})\b/);
      if (dateUK) {
        let [_, d, m, y] = dateUK; y = y.length === 2 ? ('20' + y) : y;
        const iso = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        dateInput.value = iso;
      }

      // Description: concatenate first few non-meta lines
      const desc = lines.filter(l => !/total|date|vat|thanks|visit|invoice|receipt/i.test(l)).slice(0,3).join(' · ').slice(0, 60);
      if (desc) descInput.value = desc;

      if (categorySelect.value === 'Select') categorySelect.value = 'Other';
    }

    // ===== Capture helpers =====
    function handleBlob(blob) {
      capturedBlob = blob;
      previewImg.src = URL.createObjectURL(blob);
      previewImg.classList.remove('hidden');
      video.classList.add('hidden');
      logBtn.classList.remove('hidden');
      processOCR(blob);
    }

    captureBtn.addEventListener('click', async () => {
      const vw = video.videoWidth || 1280; const vh = video.videoHeight || 960;
      canvas.width = vw; canvas.height = vh;
      const ctx = canvas.getContext('2d'); ctx.drawImage(video, 0, 0, vw, vh);
      canvas.toBlob((blob) => { if (blob) handleBlob(blob); }, 'image/jpeg');
    });

    // ===== Auth UI =====
    function updateAuthStatus() {
      const provider = cloudSelect.value; signInBtn.classList.remove('hidden');
      if (provider === 'none') { signInBtn.classList.add('hidden'); authStatus.textContent = ''; return; }
      if (provider === 'google') {
        authStatus.textContent = googleAccessToken ? 'Signed in' : 'Not signed in';
        signInBtn.textContent = googleAccessToken ? 'Sign Out' : 'Sign In';
      } else if (provider === 'onedrive') {
        authStatus.textContent = microsoftAccessToken ? 'Signed in' : 'Not signed in';
        signInBtn.textContent = microsoftAccessToken ? 'Sign Out' : 'Sign In';
      }
    }
    cloudSelect.addEventListener('change', updateAuthStatus);
    signInBtn.addEventListener('click', () => {
      const provider = cloudSelect.value;
      if (provider === 'google') {
        if (googleAccessToken) {
          try { google.accounts.oauth2.revoke(googleAccessToken); } catch {}
          gapi.client.setToken(null); googleAccessToken = null; notify('Signed out of Google', 'info');
        } else { handleGoogleAuth(); }
      } else if (provider === 'onedrive') {
        if (microsoftAccessToken) { msalInstance.logoutPopup().catch(console.error); microsoftAccessToken = null; microsoftAccount = null; notify('Signed out of Microsoft', 'info'); }
        else { handleMicrosoftAuth(); }
      }
      updateAuthStatus();
    });

    // ===== Log actions =====
    logBtn.addEventListener('click', async () => {
      const date = dateInput.value || todayISO();
      const category = categorySelect.value !== 'Select' ? categorySelect.value : 'Other';
      const amount = parseFloat(amountInput.value);
      const desc = (descInput.value || '').trim();
      if (!desc || isNaN(amount) || amount <= 0) { notify('Enter a valid amount and description.', 'warn'); return; }
      if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) { notify('Invalid date.', 'warn'); return; }
      if (!capturedBlob) { notify('Capture a photo first.', 'warn'); return; }

      const timestamp = new Date().toISOString();
      const filename = `receipt_${timestamp.replace(/[:.-]/g, '')}.jpg`;
      let cloud = { id: null, url: null, provider: cloudSelect.value };

      if (cloud.provider !== 'none') {
        try {
          if (cloud.provider === 'google' && googleAccessToken) cloud = { ...(await uploadToGoogle(capturedBlob, filename)), provider: 'google' };
          else if (cloud.provider === 'onedrive' && microsoftAccessToken) cloud = { ...(await uploadToOneDrive(capturedBlob, filename)), provider: 'onedrive' };
          else { notify('Please sign in to your cloud first.', 'warn'); return; }
        } catch (err) { notify('Upload failed: ' + err.message, 'bad'); return; }
      }

      const reader = new FileReader();
      reader.onload = () => {
        const dataURL = reader.result;
        logs.push({ timestamp, date, category, amount, desc, photoDataURL: dataURL, cloudId: cloud.id, cloudUrl: cloud.url, provider: cloud.provider });
        saveLogs();
        notify('Logged!', 'good');
        resetForm();
      };
      reader.readAsDataURL(capturedBlob);
    });

    function resetForm() {
      dateInput.value = todayISO();
      categorySelect.value = 'Select'; amountInput.value = ''; descInput.value = '';
      previewImg.classList.add('hidden'); logBtn.classList.add('hidden'); capturedBlob = null;
      if (cameraSelect.value) startCamera(cameraSelect.value); else startCamera();
    }

    // ===== View logs =====
    viewLogsBtn.addEventListener('click', () => { renderLogs(); logsSection.classList.remove('hidden'); refreshMonthFilter(); });
    monthFilter.addEventListener('change', () => renderLogs());

    function renderLogs() {
      logTbody.innerHTML = '';
      const monthSel = monthFilter.value;
      let total = 0; let count = 0;
      logs
        .filter(l => monthSel === 'all' || (l.date || '').startsWith(monthSel))
        .forEach((log, index) => {
          const tr = document.createElement('tr'); tr.className = 'border-b border-bg-line';
          const cloudCell = log.cloudUrl ? `<a href="${log.cloudUrl}" target="_blank" class="underline">Open</a>` : (log.cloudId ? (log.provider==='google' ? `<a class='underline' target='_blank' href='https://drive.google.com/file/d/${log.cloudId}/view'>Open</a>` : 'Link') : '—');
          tr.innerHTML = `
            <td class="py-2 pr-2 align-top">${log.date}</td>
            <td class="py-2 pr-2 align-top">${log.category}</td>
            <td class="py-2 pr-2 align-top">${fmtGBP(log.amount)}</td>
            <td class="py-2 pr-2 align-top">${(log.desc||'').slice(0,60)}${(log.desc||'').length>60?'…':''}</td>
            <td class="py-2 pr-2 align-top"><button class="px-2 py-1 text-xs rounded-lg bg-bg-card border border-bg-line" data-view="${index}">View</button></td>
            <td class="py-2 pr-2 align-top">${cloudCell}</td>
            <td class="py-2 pr-2 align-top"><button class="px-2 py-1 text-xs rounded-lg bg-bad/20 border border-bad/40" data-del="${index}">Delete</button></td>
          `;
          logTbody.appendChild(tr);
          total += Number(log.amount) || 0; count++;
        });
      totalAmountP.textContent = `Total: £${fmtGBP(total)}`;
      countInfo.textContent = `${count} entr${count===1?'y':'ies'}`;

      // Delegate events
      logTbody.querySelectorAll('button[data-view]').forEach(btn => btn.addEventListener('click', () => showPhoto(Number(btn.dataset.view)) ));
      logTbody.querySelectorAll('button[data-del]').forEach(btn => btn.addEventListener('click', () => deleteLog(Number(btn.dataset.del)) ));
    }

    function deleteLog(index) {
      if (!confirm('Delete this entry?')) return;
      logs.splice(index, 1); saveLogs(); renderLogs();
    }

    clearLogsBtn.addEventListener('click', () => {
      if (!confirm('Clear ALL entries?')) return;
      logs = []; saveLogs(); renderLogs();
    });

    function showPhoto(index) { popupImg.src = logs[index].photoDataURL; popup.classList.remove('hidden'); }
    closePopup.addEventListener('click', () => popup.classList.add('hidden'));
    popup.addEventListener('click', (e) => { if (e.target === popup) popup.classList.add('hidden'); });

    $1

    // Excel export with embedded images
    exportXlsxBtn.addEventListener('click', async () => {
      if (!logs.length) { notify('No data to export.', 'warn'); return; }
      try {
        const wb = new ExcelJS.Workbook();
        wb.created = new Date(); wb.modified = new Date();
        wb.creator = BRAND.name; wb.title = 'Receipt Logs';
        const ws = wb.addWorksheet('Receipts', { properties: { defaultRowHeight: 20 } });

        // Columns
        const headers = [
          { header: 'Date', key: 'date', width: 12 },
          { header: 'Category', key: 'category', width: 12 },
          { header: 'Amount (£)', key: 'amount', width: 12 },
          { header: 'Description', key: 'desc', width: 40 },
          { header: 'Photo', key: 'photo', width: 18 },
          { header: 'Provider', key: 'provider', width: 10 },
          { header: 'Cloud URL', key: 'cloudUrl', width: 45 }
        ];
        ws.columns = headers;

        // Header styling
        ws.getRow(1).font = { bold: true };
        ws.getRow(1).alignment = { vertical: 'middle' };
        ws.getRow(1).border = { bottom: { style: 'thin' } };

        // Helper to get extension from dataURL
        const extFromDataURL = (dataURL) => {
          const m = /^data:(image\/(png|jpeg|jpg));base64,/.exec(dataURL || '');
          const subtype = m ? m[2].toLowerCase() : 'jpeg';
          return subtype === 'jpg' ? 'jpeg' : subtype; // exceljs expects 'jpeg' or 'png'
        };

        // Add rows + images
        for (let i = 0; i < logs.length; i++) {
          const l = logs[i];
          const rowIndex = i + 2; // 1-based, row 1 is header
          ws.addRow({ date: l.date, category: l.category, amount: Number(l.amount)||0, desc: l.desc, provider: l.provider || '', cloudUrl: l.cloudUrl || '' });
          ws.getCell(rowIndex, 3).numFmt = '£#,##0.00';
          ws.getRow(rowIndex).height = 120; // give space for thumbnail

          if (l.photoDataURL) {
            const extension = extFromDataURL(l.photoDataURL);
            const imageId = wb.addImage({ base64: l.photoDataURL, extension });
            // Place image anchored to column E (index 5), current row
            ws.addImage(imageId, {
              tl: { col: 4.1, row: rowIndex - 1 + 0.2 }, // zero-based positions
              ext: { width: 220, height: 110 }
            });
          }
          // Hyperlink for cloud URL
          if (l.cloudUrl) {
            const cell = ws.getCell(rowIndex, 7);
            cell.value = { text: 'Open', hyperlink: l.cloudUrl };
            cell.font = { color: { argb: 'FF1D4ED8' }, underline: true };
          }
        }

        // Freeze header
        ws.views = [{ state: 'frozen', ySplit: 1 }];

        const blob = await wb.xlsx.writeBuffer();
        const file = new Blob([blob], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        saveAs(file, `receipt_logs_${Date.now()}.xlsx`);
        notify('Excel exported with images.', 'good');
      } catch (err) {
        console.error(err);
        notify('Excel export failed: ' + err.message, 'bad');
      }
    }); return; }
      const headers = ['timestamp','date','category','amount','desc','provider','cloudId','cloudUrl'];
      const rows = logs.map(l => headers.map(h => ("" + (l[h] ?? '')).replaceAll('"','""')));
      const csv = [headers.join(','), ...rows.map(r => '"' + r.join('","') + '"')].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `receipt_logs_${Date.now()}.csv`; a.click(); URL.revokeObjectURL(url);
    });

    importJsonBtn.addEventListener('click', () => importFile.click());
    importFile.addEventListener('change', async () => {
      const f = importFile.files[0]; if (!f) return; const text = await f.text();
      try { const arr = JSON.parse(text); if (!Array.isArray(arr)) throw new Error('Invalid JSON');
        logs = arr; saveLogs(); notify('Imported records.', 'good'); renderLogs(); refreshMonthFilter();
      } catch { notify('Import failed.', 'bad'); }
    });

    // ===== Init =====
    function updateDefaults() {
      dateInput.value = todayISO();
    }

    function init() {
      applyTheme(); updateDefaults(); loadCameras(); updateAuthStatus(); refreshMonthFilter();
    }

    init();
  </script></body>
</html>
